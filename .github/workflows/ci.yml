name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

permissions:
  contents: read

jobs:
  test:
    name: Test (Go ${{ matrix.go-version }})
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        go-version: ["1.24", "1.25"]
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version: ${{ matrix.go-version }}
      - run: go build ./...
      - run: go test -race -count=1 ./...

  vet:
    name: Vet
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version: "1.25"
      - run: go vet ./...

  fmt:
    name: Format
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version: "1.25"
      - name: Check gofmt
        run: |
          unformatted=$(gofmt -l .)
          if [ -n "$unformatted" ]; then
            echo "Files not formatted:"
            echo "$unformatted"
            exit 1
          fi

  lint:
    name: Lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version: "1.25"
      - uses: golangci/golangci-lint-action@v7
        with:
          version: latest

  tidy:
    name: Tidy
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version: "1.25"
      - run: go mod tidy
      - name: Check for changes
        run: git diff --exit-code go.mod

  coverage:
    name: Coverage
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version: "1.25"
      - name: Run tests with coverage
        run: go test -race -count=1 -coverprofile=coverage.out ./...
      - name: Check coverage threshold
        run: |
          total=$(go tool cover -func=coverage.out | grep total | awk '{print substr($3, 1, length($3)-1)}')
          echo "Total coverage: ${total}%"
          threshold=55
          if [ "$(echo "$total < $threshold" | bc)" -eq 1 ]; then
            echo "::error::Coverage ${total}% is below threshold ${threshold}%"
            exit 1
          fi

  vulncheck:
    name: Vulncheck
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version: "1.25"
      - uses: golang/govulncheck-action@v1

  binary-size:
    name: Binary Size
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version: "1.25"
      - name: Build binary
        run: go build -o stringer ./cmd/stringer
      - name: Check binary size
        run: |
          size=$(stat --format=%s stringer)
          baseline=$(cat .github/binary-size-baseline)
          max=$((baseline * 2))
          echo "Binary size: ${size} bytes"
          echo "Baseline:    ${baseline} bytes"
          echo "Max allowed: ${max} bytes (2x baseline)"
          if [ "$size" -gt "$max" ]; then
            echo "::error::Binary size ${size} exceeds 2x baseline ${baseline} (max: ${max})"
            exit 1
          fi
          echo "Binary size is within limits."

  commit-lint:
    name: Commit Lint
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Validate conventional commits
        run: |
          # Check all commits in the PR
          base="${{ github.event.pull_request.base.sha }}"
          head="${{ github.event.pull_request.head.sha }}"
          pattern='^(feat|fix|chore|docs|test|refactor|style|perf|ci|build|revert)(\(.+\))?: .+'
          failed=0
          while IFS= read -r msg; do
            # Skip merge commits
            if echo "$msg" | grep -qE '^Merge '; then
              continue
            fi
            if ! echo "$msg" | grep -qE "$pattern"; then
              echo "::error::Invalid commit message: $msg"
              echo "  Expected format: <type>: <description>"
              echo "  Valid types: feat, fix, chore, docs, test, refactor, style, perf, ci, build, revert"
              failed=1
            fi
          done < <(git log --format=%s "$base".."$head")
          if [ "$failed" -eq 1 ]; then
            exit 1
          fi
          echo "All commit messages follow conventional commits format."

  go-generate:
    name: Go Generate
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version: "1.25"
      - name: Run go generate
        run: go generate ./...
      - name: Check for uncommitted changes
        run: |
          if ! git diff --quiet; then
            echo "::error::Generated files are out of date. Run 'go generate ./...' and commit the changes."
            git diff --stat
            exit 1
          fi
          echo "Generated files are up to date."

  license-check:
    name: License Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version: "1.25"
      - name: Install go-licenses
        run: go install github.com/google/go-licenses@latest
      - name: Check licenses
        run: |
          # Check that all dependencies use allowed licenses
          allowed="Apache-2.0,BSD-2-Clause,BSD-3-Clause,MIT,ISC,MPL-2.0"
          go-licenses check ./... --allowed_licenses="$allowed" 2>&1 || {
            echo "::error::License compliance check failed. Some dependencies use disallowed licenses."
            echo "Allowed licenses: $allowed"
            echo ""
            echo "Run 'go-licenses report ./...' locally for details."
            exit 1
          }
          echo "All dependency licenses are compliant."
